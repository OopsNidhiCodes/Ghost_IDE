# Docker Security Configuration for GhostIDE
# This file defines security policies and configurations for code execution containers

version: '3.8'

# Security profiles for different container types
security_profiles:
  
  # Python execution container security
  python_security:
    # Resource limits
    memory_limit: "128m"
    cpu_quota: 50000  # 50% of one CPU core
    pids_limit: 50
    
    # Filesystem security
    read_only: true
    tmpfs:
      - "/tmp:rw,noexec,nosuid,nodev,size=50m"
      - "/var/tmp:rw,noexec,nosuid,nodev,size=10m"
    
    # Network isolation
    network_mode: "none"
    
    # User security
    user: "1000:1000"  # Non-root user
    
    # Capabilities
    cap_drop:
      - "ALL"
    cap_add: []  # No additional capabilities
    
    # Security options
    security_opt:
      - "no-new-privileges:true"
      - "seccomp:unconfined"  # Allow syscalls needed for Python
    
    # Environment restrictions
    environment:
      PATH: "/usr/local/bin:/usr/bin:/bin"
      HOME: "/tmp"
      USER: "ghostuser"
      SHELL: "/bin/sh"
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"
    
    # Ulimits
    ulimits:
      nproc: 50
      nofile: 100
      fsize: 10485760  # 10MB file size limit
      cpu: 30  # 30 seconds CPU time limit
    
    # Working directory
    working_dir: "/tmp"
    
    # Volumes (none allowed)
    volumes: []

  # JavaScript execution container security  
  javascript_security:
    memory_limit: "128m"
    cpu_quota: 50000
    pids_limit: 50
    read_only: true
    tmpfs:
      - "/tmp:rw,noexec,nosuid,nodev,size=50m"
      - "/var/tmp:rw,noexec,nosuid,nodev,size=10m"
    network_mode: "none"
    user: "1000:1000"
    cap_drop:
      - "ALL"
    cap_add: []
    security_opt:
      - "no-new-privileges:true"
    environment:
      PATH: "/usr/local/bin:/usr/bin:/bin"
      HOME: "/tmp"
      USER: "ghostuser"
      SHELL: "/bin/sh"
      NODE_ENV: "sandbox"
    ulimits:
      nproc: 50
      nofile: 100
      fsize: 10485760
      cpu: 30
    working_dir: "/tmp"
    volumes: []

  # Java execution container security
  java_security:
    memory_limit: "256m"  # Java needs more memory
    cpu_quota: 50000
    pids_limit: 50
    read_only: true
    tmpfs:
      - "/tmp:rw,noexec,nosuid,nodev,size=100m"  # Java needs more temp space
      - "/var/tmp:rw,noexec,nosuid,nodev,size=20m"
    network_mode: "none"
    user: "1000:1000"
    cap_drop:
      - "ALL"
    cap_add: []
    security_opt:
      - "no-new-privileges:true"
    environment:
      PATH: "/usr/local/bin:/usr/bin:/bin"
      HOME: "/tmp"
      USER: "ghostuser"
      SHELL: "/bin/sh"
      JAVA_OPTS: "-Xmx128m -Xms64m -XX:+UseSerialGC"
    ulimits:
      nproc: 50
      nofile: 100
      fsize: 10485760
      cpu: 45  # Java compilation needs more time
    working_dir: "/tmp"
    volumes: []

  # C/C++ execution container security
  cpp_security:
    memory_limit: "256m"
    cpu_quota: 50000
    pids_limit: 50
    read_only: true
    tmpfs:
      - "/tmp:rw,noexec,nosuid,nodev,size=100m"
      - "/var/tmp:rw,noexec,nosuid,nodev,size=20m"
    network_mode: "none"
    user: "1000:1000"
    cap_drop:
      - "ALL"
    cap_add: []
    security_opt:
      - "no-new-privileges:true"
    environment:
      PATH: "/usr/local/bin:/usr/bin:/bin"
      HOME: "/tmp"
      USER: "ghostuser"
      SHELL: "/bin/sh"
    ulimits:
      nproc: 50
      nofile: 100
      fsize: 10485760
      cpu: 45
    working_dir: "/tmp"
    volumes: []

# Global security settings
global_security:
  # Maximum execution time (seconds)
  max_execution_time: 30
  
  # Maximum code size (bytes)
  max_code_size: 51200  # 50KB
  
  # Maximum output size (bytes)
  max_output_size: 1048576  # 1MB
  
  # Blocked system calls (for seccomp if needed)
  blocked_syscalls:
    - "socket"
    - "connect"
    - "bind"
    - "listen"
    - "accept"
    - "sendto"
    - "recvfrom"
    - "mount"
    - "umount"
    - "chroot"
    - "pivot_root"
    - "ptrace"
    - "process_vm_readv"
    - "process_vm_writev"
    - "init_module"
    - "delete_module"
    - "kexec_load"
    - "reboot"
  
  # Allowed file extensions for uploads
  allowed_extensions:
    - ".py"
    - ".js"
    - ".java"
    - ".cpp"
    - ".c"
    - ".h"
    - ".hpp"
    - ".txt"
    - ".md"
  
  # Rate limiting configuration
  rate_limits:
    code_execution: 10  # per minute
    ai_requests: 20     # per minute
    api_requests: 100   # per minute
    file_uploads: 5     # per minute
  
  # Security monitoring
  monitoring:
    log_all_executions: true
    log_failed_validations: true
    log_rate_limit_violations: true
    log_suspicious_patterns: true
    
    # Alert thresholds
    alert_on_multiple_failures: 5  # failures in 5 minutes
    alert_on_rate_limit_violations: 3  # violations in 10 minutes
    
  # Input validation patterns
  dangerous_patterns:
    python:
      - "import\\s+(os|sys|subprocess|socket|urllib|requests|shutil|tempfile|pickle|marshal)"
      - "from\\s+(os|sys|subprocess|socket|urllib|requests|shutil|tempfile|pickle|marshal)\\s+import"
      - "(exec|eval|compile|__import__|getattr|setattr|delattr)\\s*\\("
      - "open\\s*\\("
      - "file\\s*\\("
      - "(input|raw_input)\\s*\\("
    
    javascript:
      - "require\\s*\\("
      - "(process|global|Buffer|console)\\."
      - "fs\\."
      - "child_process"
      - "cluster"
      - "crypto"
      - "net"
      - "http"
      - "https"
    
    java:
      - "import\\s+java\\.(io|net|nio|lang\\.reflect|lang\\.Runtime)"
      - "System\\.(exit|gc|load|loadLibrary)"
      - "Runtime\\.getRuntime"
      - "ProcessBuilder"
      - "Class\\.forName"
    
    cpp:
      - "#include\\s*<(system|exec|fork|socket|network|fstream|iostream)"
      - "(system|exec|fork|popen)\\s*\\("
      - "std::(system|exit)"